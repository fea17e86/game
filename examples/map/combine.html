<!Doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>combine maps</title>
    <style>
        body {
            margin: 0;
            padding: 0;
        }
    </style>
</head>
<body>
    <script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
    <script src="https://code.jquery.com/ui/1.11.2/jquery-ui.js"></script>
    <script src="../../js/phaser/phaser.min.js"></script>
    <script src="../../js/phaser-ext.js"></script>
    <script src="../../js/tileset.js"></script>
    <script src="../../js/map.js"></script>
    <script>
        var Phaser = Phaser;
        var Fea = Fea;
        
        var gridSize = 32;
        
        var resources = {
            sprites : {"Tileset": "../../assets/sprites/terrain/Tileset.png"},
            maps : {
                "first" : "../../assets/data/maps/first.json",
                "second" : "../../assets/data/maps/first.json"
            }
        };
        
        var maps = [];
        
        function createMapRequests () {
            var requests = [];
            for (var m in resources.maps) {
                requests.push($.getJSON(resources.maps[m]).done(addMap));
            }
            return requests;
        }
        
        function addMap (data) {
            var map;
            if ((map = createMap(data))) {
                maps.push(map);
            }
        }
        
        function createMap (data) {
            if (data && data.width && data.height) {
                var width = data.width * data.tilewidth;
                var height = data.height * data.tileheight;
                var game = new Phaser.Game(width, height, Phaser.AUTO, "", {
                    preload : preload, create : create
                });
                game._map = new Fea.Map({ json : data, game : game });
                return game;
            }
        }
        
        function preload () {
            for (var i=0; i<this.game._map.tilesets.length; i++) {
                var ts = this.game._map.tilesets[i];
                if (resources.sprites[ts.name]) {
                    this.game.load.spritesheet(ts.name, resources.sprites[ts.name], ts.tilewidth, ts.tileheight, -1,  ts.margin, ts.spacing);
                }
            }
        }
        
        function create () {
            this.game._map.draw(0, 0);
            $(this.game.canvas).draggable({ grid : [ gridSize, gridSize ] });
        }
        
        $(function () {
            $.when.apply($, createMapRequests()).then(function() {});
        });
    </script>
</body>
</html>